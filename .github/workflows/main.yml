name: ğŸ“Š Update Football Dataset

# CuÃ¡ndo se ejecuta
on:
  # OpciÃ³n 1: Ejecutar manualmente desde GitHub
  workflow_dispatch:
  
  # OpciÃ³n 2: Ejecutar automÃ¡ticamente cada semana (lunes 3 AM)
  schedule:
    - cron: '0 3 * * 2'  # Lunes a las 3 AM UTC

# Permisos necesarios
permissions:
  contents: write  # Para hacer commit y push

jobs:
  update-dataset:
    name: ğŸ”„ Download & Process Data
    runs-on: ubuntu-latest
    
    steps:
      # ============================================
      # PASO 1: Descargar cÃ³digo del repositorio
      # ============================================
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      # ============================================
      # PASO 2: Configurar Python
      # ============================================
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'  # Cachear dependencias para acelerar
      
      # ============================================
      # PASO 3: Instalar dependencias
      # ============================================
      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install --upgrade pip
          pip install pandas numpy soccerdata scikit-learn
      
      # ============================================
      # PASO 4: Descargar datos desde FBref
      # ============================================
      - name: ğŸŸï¸ Download Raw Data (generate_dataset.py)
        run: |
          echo "ğŸ“¥ Descargando datos de FBref..."
          python -c "from src.process_data.generate_dataset import GENERATE_DATASET; GENERATE_DATASET(True)"
          echo "âœ… Datos descargados"
      
      # ============================================
      # PASO 5: Verificar que se creÃ³ el dataset
      # ============================================
      - name: âœ… Check Downloaded Files
        run: |
          echo "ğŸ“‚ Verificando archivos descargados:"
          ls -lh dataset/cleaned/
          echo ""
          echo "ğŸ“Š Primeras lÃ­neas del dataset:"
          head -n 5 dataset/cleaned/dataset_cleaned.csv
      
      # ============================================
      # PASO 6: Procesar features (Machine Learning)
      # ============================================
      - name: âš™ï¸ Process Features (process_dataset.py)
        run: |
          echo "âš™ï¸ Procesando features para ML..."
          python -c "from src.process_data.process_dataset import PROCESS_DATA; PROCESS_DATA(True)"
          echo "âœ… Features procesadas"
      
      # ============================================
      # PASO 7: Verificar dataset procesado
      # ============================================
      - name: âœ… Check Processed Files
        run: |
          echo "ğŸ“‚ Verificando dataset procesado:"
          ls -lh dataset/processed/
          echo ""
          echo "ğŸ“Š Info del dataset:"
          python -c "import pandas as pd; df = pd.read_csv('dataset/processed/dataset_processed.csv'); print(f'Filas: {len(df)}, Columnas: {len(df.columns)}')"
      
      # ============================================
      # PASO 8: Guardar cambios en GitHub
      # ============================================
      - name: ğŸ’¾ Commit & Push Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Agregar archivos
          git add dataset/cleaned/dataset_cleaned.csv
          git add dataset/processed/dataset_processed.csv
          
          # Verificar si hay cambios
          if git diff --staged --quiet; then
            echo "âš ï¸ No hay cambios en el dataset"
          else
            # Hacer commit
            git commit -m "ğŸ¤– Auto-update dataset $(date +'%Y-%m-%d %H:%M')"
            
            # Push
            git push
            
            echo "âœ… Dataset actualizado y subido a GitHub"
          fi
      
      # ============================================
      # PASO 9: Resumen final
      # ============================================
      - name: ğŸ“‹ Summary
        if: always()
        run: |
          echo "================================"
          echo "ğŸ“Š RESUMEN DE EJECUCIÃ“N"
          echo "================================"
          echo "âœ… Datos descargados desde FBref"
          echo "âœ… Features procesadas"
          echo "âœ… Datasets guardados en GitHub"
          echo ""
          echo "ğŸ“‚ Archivos generados:"
          echo "   - dataset/cleaned/dataset_cleaned.csv"
          echo "   - dataset/processed/dataset_processed.csv"
          echo "================================"